┌─────────────────────────────────────────────────────────────────────────────────┐
│                    DROID CLI + OPUS HANG - ROOT CAUSE FLOW                       │
└─────────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐
│  Droid CLI   │
│  + Opus      │
└──────┬───────┘
       │ Request with tools
       ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Proxy: build_target_param (lines 445-469)                          │
│                                                                      │
│  if has_tools:                                                       │
│      payload['stream'] = False  ◄─── Force non-streaming            │
│      request.state.legacy_chatcompletions_stream = True             │
│                                                                      │
│  Reason: A4F API doesn't support streaming with tool calling        │
└──────────────────────────────┬──────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Upstream API Response (non-streaming JSON)                         │
│                                                                      │
│  {                                                                   │
│    "choices": [{                                                     │
│      "message": {                                                    │
│        "role": "assistant",                                          │
│        "content": null,  ◄─── OPUS: Often null/empty with tools    │
│        "tool_calls": [...]                                           │
│      },                                                              │
│      "finish_reason": "tool_calls"                                   │
│    }]                                                                │
│  }                                                                   │
└──────────────────────────────┬──────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Proxy: _ChatCompletionsSseTransformer.flush() (lines 663-805)     │
│                                                                      │
│  1. Buffer entire response ✓                                        │
│  2. Parse JSON response ✓                                           │
│  3. Extract content field:                                          │
│                                                                      │
│     content = message_block.get('content')  # None or null          │
│     text_value = ''  # Empty string after processing                │
│                                                                      │
│  4. Build delta object:                                             │
│                                                                      │
│     delta = {'role': 'assistant'}                                   │
│                                                                      │
│     if text_value:  ◄─── BUG: False when empty!                    │
│         delta['content'] = text_value                               │
│                                                                      │
│     tool_calls = message_block.get('tool_calls')                    │
│     if tool_calls:                                                   │
│         delta['tool_calls'] = tool_calls                            │
│                                                                      │
│  5. Result for Opus:                                                │
│     delta = {                                                        │
│         'role': 'assistant',                                         │
│         'tool_calls': [...]                                          │
│         # ❌ NO 'content' FIELD!                                    │
│     }                                                                │
│                                                                      │
│  6. Result for Sonnet (with text):                                  │
│     delta = {                                                        │
│         'role': 'assistant',                                         │
│         'content': 'I will use the Read tool...',                   │
│         'tool_calls': [...]                                          │
│         # ✓ 'content' field present                                │
│     }                                                                │
└──────────────────────────────┬──────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│  SSE Chunk Generation                                               │
│                                                                      │
│  Chunk 1:                                                            │
│  data: {                                                             │
│    "choices": [{                                                     │
│      "delta": {                                                      │
│        "role": "assistant",                                          │
│        "tool_calls": [...]                                           │
│        // ❌ Missing 'content' field                                │
│      }                                                               │
│    }]                                                                │
│  }                                                                   │
│                                                                      │
│  Chunk 2:                                                            │
│  data: {"choices": [{"delta": {}, "finish_reason": "tool_calls"}]}  │
│                                                                      │
│  Chunk 3:                                                            │
│  data: [DONE]                                                        │
└──────────────────────────────┬──────────────────────────────────────┘
                                │
                 ┌──────────────┴──────────────┐
                 │                             │
                 ▼                             ▼
      ┌──────────────────┐          ┌───────────────────┐
      │   Droid CLI      │          │   Roo Code        │
      │   (Strict)       │          │   (Lenient)       │
      └────────┬─────────┘          └─────────┬─────────┘
               │                              │
               ▼                              ▼
      ┌──────────────────┐          ┌───────────────────┐
      │ SSE Parser       │          │ SSE Parser        │
      │                  │          │                   │
      │ Expects:         │          │ Treats missing    │
      │ - role ✓         │          │ content as ''     │
      │ - content ❌     │          │                   │
      │ - tool_calls ✓   │          │ Completes ✓       │
      │                  │          └───────────────────┘
      │ Waits for        │
      │ content field... │
      │                  │
      │ ⏰ HANGS         │
      └──────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                              THE FIX                                 │
└─────────────────────────────────────────────────────────────────────┘

  Line 794 in src/legacy/proxy.py:

  ❌ BEFORE:
     if text_value:
         delta['content'] = text_value

  ✅ AFTER:
     delta['content'] = text_value or ''

  Result:
     delta = {
         'role': 'assistant',
         'content': '',  ◄─── Always present, even when empty
         'tool_calls': [...]
     }

  ✓ Droid CLI: Satisfied, continues parsing
  ✓ Roo Code: Still works (backward compatible)
  ✓ OpenAI Spec: Compliant (content field always present)

┌─────────────────────────────────────────────────────────────────────┐
│                         COMPARISON TABLE                             │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────┬───────────────┬───────────────┬──────────────────────┐
│ Scenario     │ Content Value │ Current Bug   │ After Fix            │
├──────────────┼───────────────┼───────────────┼──────────────────────┤
│ Opus + Tools │ null/empty    │ Field omitted │ content: ''          │
│              │               │ Droid hangs   │ Droid works ✓        │
├──────────────┼───────────────┼───────────────┼──────────────────────┤
│ Sonnet+Tools │ "I'll use..." │ content: text │ content: text        │
│              │               │ Droid works ✓ │ Droid works ✓        │
├──────────────┼───────────────┼───────────────┼──────────────────────┤
│ Roo Code     │ null/empty    │ Works ✓       │ Works ✓              │
│ (Lenient)    │               │ (lenient)     │ (backward compat)    │
└──────────────┴───────────────┴───────────────┴──────────────────────┘

